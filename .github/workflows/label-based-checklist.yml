name: Label-Based Checklist

on:
  pull_request:
    types: [labeled, unlabeled, opened, reopened]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  update-label-checklist:
    name: Update Label-Specific Checklist
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load checklist definitions
        id: load-defs
        run: |
          echo "defs<<EOF" >> $GITHUB_OUTPUT
          cat .github/pr-checklists.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get PR labels and generate checklists
        id: generate
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            // Load checklist definitions
            const definitions = JSON.parse(`${{ steps.load-defs.outputs.defs }}`);
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const labels = pr.labels.map(l => l.name);
            console.log('PR Labels:', labels);

            // Generate checklists based on labels
            const checklists = [];
            const labelDefinitions = definitions.label_checklists;

            for (const label of labels) {
              if (labelDefinitions[label]) {
                const def = labelDefinitions[label];
                const items = def.items.map(item => `- [ ] ${item}`).join('\n');

                const checklistText = [
                  `## ${def.title}`,
                  '',
                  def.description,
                  '',
                  items,
                  '',
                  def.footer || ''
                ].join('\n').trim();

                checklists.push(checklistText);
              }
            }

            // Generate final comment
            let comment = '';

            if (checklists.length === 0) {
              const labelsList = labels.length > 0 ? labels.map(l => `\`${l}\``).join(', ') : '_No labels_';
              comment = [
                '## üè∑Ô∏è Label-Based Checklist',
                '',
                '**No specific label requirements detected.**',
                '',
                `Current labels: ${labelsList}`,
                '',
                'Add labels to this PR (bug, enhancement, security, etc.) to see relevant checklist items here.',
                '',
                '---',
                '*This comment updates automatically when labels change.*'
              ].join('\n');
            } else {
              const labelsList = labels.map(l => `\`${l}\``).join(', ');
              comment = [
                '## üè∑Ô∏è Label-Based Checklist',
                '',
                'Based on the labels applied to this PR, please complete these additional requirements:',
                '',
                `**Labels:** ${labelsList}`,
                '',
                '---',
                '',
                checklists.join('\n\n---\n\n'),
                '',
                '---',
                '',
                '**Instructions:**',
                '1. Check off items as you complete them (change `- [ ]` to `- [x]`)',
                '2. Edit this comment to update checkboxes',
                '3. The PR checklist CI will verify these are completed',
                '',
                '*This comment updates automatically when labels change.*'
              ].join('\n');
            }

            return JSON.stringify({ comment, labelCount: labels.length, checklistCount: checklists.length });

      - name: Post or update checklist comment
        uses: actions/github-script@v7
        env:
          RESULT_JSON: ${{ steps.generate.outputs.result }}
        with:
          script: |
            const result = JSON.parse(process.env.RESULT_JSON);
            const comment = result.comment;

            // Find existing label-based checklist comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('üè∑Ô∏è Label-Based Checklist')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing label-based checklist comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
              console.log('Created new label-based checklist comment');
            }

            console.log(`Generated ${result.checklistCount} checklist(s) for ${result.labelCount} label(s)`);
