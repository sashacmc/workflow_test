name: PR Checklist Verification

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches: ["**"]
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: read
  contents: read

jobs:
  verify-checklist:
    name: Verify PR Checklist Completion
    runs-on: ubuntu-latest
    # Only run on PRs (skip non-PR issue comments)
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)

    steps:
      - name: Get PR number
        id: pr-number
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            if (context.eventName === 'pull_request') {
              return context.payload.pull_request.number;
            } else if (context.eventName === 'issue_comment') {
              return context.payload.issue.number;
            }
            return null;

      - name: Get PR body
        id: pr
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const prNumber = parseInt(`${{ steps.pr-number.outputs.result }}`);
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            return JSON.stringify({
              number: prNumber,
              body: pullRequest.body || '',
              labels: pullRequest.labels.map(l => l.name)
            });

      - name: Get label-based checklist comment
        id: label-checklist
        uses: actions/github-script@v7
        env:
          PR_DATA: ${{ steps.pr.outputs.result }}
        with:
          result-encoding: string
          script: |
            const prData = JSON.parse(process.env.PR_DATA);
            // Find label-based checklist comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prData.number
            });

            const labelComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ·ï¸ Label-Based Checklist')
            );

            return labelComment ? labelComment.body : '';

      - name: Verify checklist items
        id: verify
        uses: actions/github-script@v7
        env:
          PR_DATA: ${{ steps.pr.outputs.result }}
          LABEL_CHECKLIST: ${{ steps.label-checklist.outputs.result }}
        with:
          result-encoding: string
          script: |
            const prData = JSON.parse(process.env.PR_DATA);
            const body = prData.body;
            const labels = prData.labels;
            const labelChecklistBody = process.env.LABEL_CHECKLIST;

            // Combine PR body and label checklist for verification
            const combinedBody = body + '\n\n' + labelChecklistBody;

            // Count all checkboxes (checked and unchecked)
            const allCheckboxesPR = (body.match(/- \[[ x]\]/gi) || []).length;
            const checkedCheckboxesPR = (body.match(/- \[x\]/gi) || []).length;
            const uncheckedCheckboxesPR = allCheckboxesPR - checkedCheckboxesPR;

            const allCheckboxesLabel = (labelChecklistBody.match(/- \[[ x]\]/gi) || []).length;
            const checkedCheckboxesLabel = (labelChecklistBody.match(/- \[x\]/gi) || []).length;
            const uncheckedCheckboxesLabel = allCheckboxesLabel - checkedCheckboxesLabel;

            const totalCheckboxes = allCheckboxesPR + allCheckboxesLabel;
            const checkedCheckboxes = checkedCheckboxesPR + checkedCheckboxesLabel;
            const uncheckedCheckboxes = uncheckedCheckboxesPR + uncheckedCheckboxesLabel;

            console.log(`PR body: ${checkedCheckboxesPR}/${allCheckboxesPR} checked`);
            console.log(`Label checklist: ${checkedCheckboxesLabel}/${allCheckboxesLabel} checked`);
            console.log(`Total: ${checkedCheckboxes}/${totalCheckboxes} checked`);
            console.log(`Unchecked: ${uncheckedCheckboxes}`);

            // Simple rule: ALL boxes must be checked
            let status = 'success';
            let message = `All checklist items completed (${totalCheckboxes}/${totalCheckboxes})`;

            if (uncheckedCheckboxes > 0) {
              status = 'failure';
              const uncheckedInPR = uncheckedCheckboxesPR > 0 ? `${uncheckedCheckboxesPR} in PR description` : null;
              const uncheckedInLabel = uncheckedCheckboxesLabel > 0 ? `${uncheckedCheckboxesLabel} in label checklist` : null;
              const uncheckedParts = [uncheckedInPR, uncheckedInLabel].filter(Boolean).join(', ');
              message = `Checklist incomplete: ${uncheckedCheckboxes} unchecked item(s) (${uncheckedParts})`;
            }

            core.setOutput('status', status);
            core.setOutput('message', message);
            core.setOutput('checked', checkedCheckboxes);
            core.setOutput('total', totalCheckboxes);
            core.setOutput('unchecked', uncheckedCheckboxes);

            return JSON.stringify({
              status,
              message,
              checked: checkedCheckboxes,
              total: totalCheckboxes,
              unchecked: uncheckedCheckboxes
            });

      - name: Report status
        uses: actions/github-script@v7
        env:
          VERIFY_RESULT: ${{ steps.verify.outputs.result }}
        with:
          script: |
            const result = JSON.parse(process.env.VERIFY_RESULT);
            const status = '${{ steps.verify.outputs.status }}';
            const message = `${{ steps.verify.outputs.message }}`;

            console.log(`Status: ${status}`);
            console.log(`Message: ${message}`);

      - name: Set job status
        if: steps.verify.outputs.status == 'failure'
        run: |
          echo "::error::PR checklist verification failed. Please complete required checklist items."
          exit 1
